<!doctype html><html>
<head>
<title>
BGP - Tucson Mesh Docs
</title><meta name=viewport content="width=device-width,initial-scale=1">
<link href=../../css/main.css rel=stylesheet>
<meta property="og:title" content="BGP - Tucson Mesh Docs">
<meta property="og:type" content="article">
<meta property="article:published_time" content="0001-01-01">
<meta property="og:description" content>
<meta property="og:url" content="/networking/bgp/">
<meta property="og:site_name" content="Tucson Mesh Docs">
<meta property="twitter:description" content>
<meta property="twitter:title" content="BGP - Tucson Mesh Docs">
</head><body class=sans-serif>
<div class="h-100 flex-ns">
<div id=sidebar class="relative ph4-l ph3 flex justify-end-ns br bg-near-white b--light-gray">
<div class="mw5 w-100 overflow-y-hidden flex flex-column">
<div class="nowrap flex items-center justify-start h3">
<a href=../../ title=Home class="f3-ns f4 fw7 black nowrap flex items-center">
<img src=../../img/logo.svg class="h2 mr2">
<span class=f4>NYC Mesh
<span class="ml1 blue f5 ttu">Docs</span></span>
</a>
</div><div role=button class="hideDropdown h3 w3 flex items-center justify-center" tabindex=0><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</div><div role=button class="showDropdown bg-near-white h3 w3 flex items-center justify-center" tabindex=0><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</div><div class="dn db-ns dropdown overflow-y-auto pbv4-ns mt4-ns">
<ul class="list ma0 ph0">
<li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../intro/ class="db black">Introduction</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../hardware/ class="db black">Hardware</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../firmware/ class="db black">Firmware</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../diy/ class="db black">DIY & Troubleshooting</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../glossary/ class="db black">Glossary</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../installs/ class="db black">Installs</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 10 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M5 11 0 6l1.5-1.5L5 8.25 8.5 4.5 10 6z"/></svg>
<a href=../../networking/ class="db black">Networking</a>
</div><ul class="ma0 pa0 ml3 pl2">
<a href=../../networking/10-69-net-network/ class="db mv3 ml0 gray">
10-69-net Network
</a>
<a href=../../networking/bgp/ class="db mv3 ml0 gray blue fw5">
BGP
</a>
<a href=../../networking/classes/ class="db mv3 ml0 gray">
Classes
</a>
<a href=../../networking/dns/ class="db mv3 ml0 gray">
DNS
</a>
<a href=../../networking/hubs/ class="db mv3 ml0 gray">
Hubs
</a>
<a href=../../networking/ipmappingidea/ class="db mv3 ml0 gray">
IP Mapping Idea
</a>
<a href=../../networking/mesh/ class="db mv3 ml0 gray">
Mesh Design
</a>
<a href=../../networking/ntp/ class="db mv3 ml0 gray">
NTP Network Time Protocol
</a>
<a href=../../networking/ospf/ class="db mv3 ml0 gray">
OSPF
</a>
<a href=../../networking/peering/ class="db mv3 ml0 gray">
Public ASN Peering
</a>
<a href=../../networking/supernode-architecture/ class="db mv3 ml0 gray">
Supernode Architecture
</a>
<a href=../../networking/vpn/ class="db mv3 ml0 gray">
VPN
</a>
<a href=../../networking/vpnl2tpipsec/ class="db mv3 ml0 gray">
VPN - L2TP/IPsec
</a>
<a href=../../networking/vpnl2tpipsecid/ class="db mv3 ml0 gray">
VPN - L2TP/IPsec Req.
</a>
<a href=../../networking/vpnwireguard/ class="db mv3 ml0 gray">
VPN - WireGuard
</a>
<a href=../../networking/vpnwireguardospf/ class="db mv3 ml0 gray">
VPN - WireGuard + OSPF
</a>
</ul></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../nodes/ class="db black">Nodes</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../organization/ class="db black">Organization</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../security/ class="db black">Security</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../services/ class="db black">Services</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../software/ class="db black">Software</a>
</div></li></ul></div></div></div><div class="overflow-y-scroll-ns w-80-ns">
<header class="dn ph4 h3 flex-ns flex-row items-center justify-start-l justify-center sans-serif bg-white">
<div class="w-100-ns f4 measure-wide flex items-center justify-end">
<nav class="f5 flex flex-wrap justify-center">
<a href=https://nycmesh.net/ class="f5 blue">Main Site â†’</a>
</nav></div></header><main class="bg-white bt bw05 b--light-gray sans-serif flex flex-row-l flex-column">
<div class="bg-white w-100 pa4-ns pa3">
<div class=f4>
<div class="flex items-center justify-between">
<h1 class=mv0>
BGP
</h1><a class="nowrap pl2" target=_ href=https://github.com/nycmeshnet/docs/blob/master/content/networking/bgp.md>
<div class="ba b--light-gray br2 pa2 f6 fw5 black flex"><svg class="mr1 h1 db-ns dn" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
<span>Edit<span class="dn di-ns pre"> on GitHub</span></span>
</div></a>
</div><div class=f5>
<div class=f6>
<p>
Last updated
April 20, 2020 by Zach
</p></div><p>The <a href=https://tools.ietf.org/html/rfc4271>Border Gateway Protocol</a> (BGP) is an inter-Autonomous System routing protocol.</p><p>NYC Mesh no longer uses BGP within the mesh between neighbors / members. Use of BGP within the mesh was too static for the changing network, lacked some &ldquo;automatic&rdquo; properties, and made it difficult to train new people.</p><h2 id=use-outside-nyc-mesh>Use outside NYC Mesh</h2><p>BGP is a popular dynamic routing protocol as it is relatively simple to configure, scales well and enjoys support across multiple hardware and software vendors. The internet uses BGP to interconnect all the thousands of companies, ISPs, and Exchanges that make up the internet.</p><h2 id=use-within-nyc-mesh>Use within NYC Mesh</h2><p>NYC Mesh uses BGP to connect to the internet at Supernodes. In fact .. it is a requirement of a Supernode.<br>
With BGP, we are able to connect our &ldquo;Autonomous System&rdquo; ( our organization&rsquo;s ID ) with other organizations, such as ISPs, and participate in the internet. By doing this, we carry our organization&rsquo;s IP addresses along with us and create many redundant connections to the internet.</p><p>Supernodes require BGP to connect to the internet because NYC Mesh has dedicated IP Addresses for use by our organization. In order to maintain proper functionality with the internet, we need to ensure we maintain a BGP connection at critical internet connection points, or, Supernodes.</p><h2 id=old-instructions>Old Instructions</h2><p>It is still possible to connect a BGP-only speaking device to the mesh, please coordinate with the larger group to do so, as it requires some planning.</p><p>Expand to see some older BGP information that is kept for informational purposes and the eventuality that BGP is needed for some devices</p><details>
<summary>Expand to view details...</summary>
<h2 id=communities>Communities</h2><p><a href=https://tools.ietf.org/html/rfc1997>BGP communities</a> can be used to classify routes that are imported or exported by an AS. Some definitions generally agreed upon by BGP speakers within the mesh are listed below. They are primarily used for interpreting the &ldquo;quality&rdquo; of various routes to the internet.</p><table>
<thead>
<tr>
<th>Community</th><th>Meaning</th><th>Suggested interpretation</th></tr></thead><tbody>
<tr>
<td>65000:1001</td><td>Internet connected by NYC Mesh</td><td>Set local preference to 130</td></tr><tr>
<td>65000:1002</td><td>Internet connected by a fast, neutral 3rd party</td><td>Set local preference to 110</td></tr><tr>
<td>65000:1003</td><td>Internet connected by a fast, non-neutral 3rd party</td><td>Set local preference to 100</td></tr><tr>
<td>65000:1004</td><td>Internet connected by a slow, non-neutral 3rd party</td><td>Set local preference to 90</td></tr><tr>
<td>65000:1005</td><td>Internet connected by a slow, NATed or possibly compromised 3rd party</td><td>Set local preference to 80</td></tr></tbody></table><h2 id=prefix-lists>Prefix lists</h2><p>IPv4 and IPv6 prefix lists that BGP speakers within the mesh commonly filter on (for import and export) are listed below:</p><h3 id=ipv4>IPv4</h3><table>
<thead>
<tr>
<th>Prefix (Bird notation)</th><th>Action</th></tr></thead><tbody>
<tr>
<td>199.167.59.0/24{24,32}</td><td>Allow</td></tr><tr>
<td>10.0.0.0/8{22,32}</td><td>Allow</td></tr><tr>
<td>0.0.0.0/0</td><td>Allow</td></tr><tr>
<td>All others</td><td>Deny</td></tr></tbody></table><h3 id=ipv6>IPv6</h3><table>
<thead>
<tr>
<th>Prefix (Bird notation)</th><th>Action</th></tr></thead><tbody>
<tr>
<td>2620:12d:400d::/48{48,64}</td><td>Allow</td></tr><tr>
<td>fdff:1508:6410::/48{64,128}</td><td>Allow</td></tr><tr>
<td>::/0</td><td>Allow</td></tr><tr>
<td>All others</td><td>Deny</td></tr></tbody></table><h2 id=how-to-get-an-asn-or-ip-allocation>How to get an ASN or IP allocation</h2><p>Currently the mesh uses a spreadsheet to keep track of allocated resources. The process will be automated soon, but in the mean time please contact an existing member via <a href=https://slack.nycmesh.net>Slack</a> or <a href=mailto:contact@nycmesh.net>email</a> to have them help you acquire an ASN and IPv4 and/or IPv6 resources.</p><h2 id=examples>Examples</h2><p>Some configuration examples for BGP implementations known to be in use within NYC Mesh today are listed below in no particular order.</p><h3 id=birdhttpbirdnetworkcz><a href=http://bird.network.cz>Bird</a></h3><p>Bird is an open source routing daemon with support for a number of different routing protocols including BGP.</p><details>
<summary>**Expand Bird Example**</summary>
```
log stderr all;
<p>router id 10.70.x.1;</p><p>function is_mesh_prefix_v4 () {
return net ~ [
199.167.59.0/24{24,32},
10.0.0.0/8{22,32},
0.0.0.0/0
];
}</p><p>function is_mesh_prefix_v6 {
return net ~ [
2620:12d:400d::/48{48,64},
fdff:1508:6410::/48{64,128},
::/0
];
}</p><p>function set_local_pref () {
if (65000,1001) ~ bgp_community then bgp_local_pref = 130;
if (65000,1002) ~ bgp_community then bgp_local_pref = 110;
if (65000,1003) ~ bgp_community then bgp_local_pref = 100;
if (65000,1004) ~ bgp_community then bgp_local_pref = 90;
if (65000,1005) ~ bgp_community then bgp_local_pref = 80;
}</p><p>filter is_not_deviceroute {
if source = RTS_DEVICE then reject;
accept;
}</p><p>filter mesh_import_v4 {
if ! is_mesh_prefix_v4() then reject;
set_local_pref();
accept;
}</p><p>filter mesh_export_v4 {
if ! is_mesh_prefix_v4() then reject;
if ifname = &ldquo;eth0&rdquo; then bgp_community.add((65000,1005));
accept;
}</p><p>filter mesh_import_v6 {
if ! is_mesh_prefix_v6() then reject;
set_local_pref();
accept;
}</p><p>filter mesh_export_v6 {
if ! is_mesh_prefix_v6() then reject;
if ifname = &ldquo;eth0&rdquo; then bgp_community.add((65000,1005));
accept;
}</p><p>protocol device {
scan time 10;
}</p><p>protocol direct {
ipv4;
interface &ldquo;br0&rdquo; &ldquo;eth0&rdquo;;
}</p><p>protocol kernel {
scan time 10;
ipv4 {
export filter is_not_deviceroute;
};
}</p><p>protocol kernel {
scan time 10;
ipv6 {
export filter is_not_deviceroute;
};
}</p><p>template bgp meshpeer {
local 10.70.x.1 as 65xxx;
hold time 15;
keepalive time 5;
ipv4 {
next hop self;
import filter mesh_import_v4;
export filter mesh_export_v4;
};
ipv6 {
next hop self;
import filter mesh_import_v6;
export filter mesh_export_v6;
};
}</p><p>protocol bgp n1234 from meshpeer {
neighbor 10.70.x.y as 65yyy;
}</p><pre tabindex=0><code>&lt;/details&gt;

### [UBNT/EdgeOS](https://www.ubnt.com/products/#edgemax)
UBNT&#39;s EdgeOS was forked from Vyatta, which in turn borrows from [Quagga](https://www.nongnu.org/quagga/).
&lt;details&gt;
&lt;summary&gt;**Expand for UBNT/EdgeOS Example**&lt;/summary&gt;
</code></pre><p>protocols {
bgp 65xxx {
neighbor 10.70.x.y {
description n1234
nexthop-self
remote-as 65yyy
route-map {
export nycmeshexport
import nycmeshimport
}
soft-reconfiguration {
inbound
}
}
network 10.70.x.0/24 {
}
network 199.167.59.x/32 {
}
parameters {
router-id 10.70.x.1
}
timers {
holdtime 15
keepalive 5
}
redistribute {
static {
route-map nycmeshexportIspDefault
}
}
}
static {
route 10.70.x.0/24 {
blackhole {
}
}
}
}
policy {
community-list 101 {
rule 10 {
action permit
regex 65000:1001
}
}
community-list 102 {
rule 10 {
action permit
regex 65000:1002
}
}
community-list 103 {
rule 10 {
action permit
regex 65000:1003
}
}
community-list 104 {
rule 10 {
action permit
regex 65000:1004
}
}
community-list 105 {
rule 10 {
action permit
regex 65000:1005
}
}
prefix-list nycmeshprefixes {
rule 10 {
action permit
ge 22
le 32
prefix 10.0.0.0/8
}
rule 20 {
action permit
ge 24
le 32
prefix 199.167.56.0/22
}
rule 30 {
action permit
prefix 0.0.0.0/0
}
}
route-map nycmeshexport {
rule 10 {
action permit
match {
ip {
address {
prefix-list nycmeshprefixes
}
}
}
}
rule 20 {
action deny
}
}
route-map nycmeshexportIspDefault {
rule 10 {
action permit
match {
interface eth0
}
set {
community &ldquo;65000:1005 additive&rdquo;
}
}
rule 20 {
action deny
}
}
route-map nycmeshimport {
rule 10 {
action permit
match {
community {
community-list 101
}
}
set {
local-preference 130
}
}
rule 20 {
action permit
match {
community {
community-list 102
}
}
set {
local-preference 110
}
}
rule 30 {
action permit
match {
community {
community-list 103
}
}
set {
local-preference 100
}
}
rule 40 {
action permit
match {
community {
community-list 104
}
}
set {
local-preference 90
}
}
rule 50 {
action permit
match {
community {
community-list 105
}
}
set {
local-preference 80
}
}
rule 60 {
action permit
match {
ip {
address {
prefix-list nycmeshprefixes
}
}
}
}
rule 70 {
action deny
}
}
}</p><pre tabindex=0><code>&lt;/details&gt;

### [Mikrotik/RouterOS](https://wiki.mikrotik.com/wiki/Manual:TOC)
Mikrotik&#39;s RouterOS has its own closed source BGP implementation.  
**TODO**

### [OpenBGPD](http://www.openbgpd.org/)
An example of a working configuration, abeit without BGP community rules, is available [here](https://github.com/bongozone/kibble/blob/master/src/etc/bgpd.conf).

&lt;details&gt;
</code></pre></div></div></div></main></div></div></body></html>