<!doctype html><html>
<head>
<title>
Watchdog - Tucson Mesh Docs
</title><meta name=viewport content="width=device-width,initial-scale=1">
<link href=../../css/main.css rel=stylesheet>
<meta property="og:title" content="Watchdog - Tucson Mesh Docs">
<meta property="og:type" content="article">
<meta property="article:published_time" content="0001-01-01">
<meta property="og:description" content>
<meta property="og:url" content="/software/watchdog/">
<meta property="og:site_name" content="Tucson Mesh Docs">
<meta property="twitter:description" content>
<meta property="twitter:title" content="Watchdog - Tucson Mesh Docs">
</head><body class=sans-serif>
<div class="h-100 flex-ns">
<div id=sidebar class="relative ph4-l ph3 flex justify-end-ns br bg-near-white b--light-gray">
<div class="mw5 w-100 overflow-y-hidden flex flex-column">
<div class="nowrap flex items-center justify-start h3">
<a href=../../ title=Home class="f3-ns f4 fw7 black nowrap flex items-center">
<img src=../../img/logo.svg class="h2 mr2">
<span class=f4>NYC Mesh
<span class="ml1 blue f5 ttu">Docs</span></span>
</a>
</div><div role=button class="hideDropdown h3 w3 flex items-center justify-center" tabindex=0><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</div><div role=button class="showDropdown bg-near-white h3 w3 flex items-center justify-center" tabindex=0><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</div><div class="dn db-ns dropdown overflow-y-auto pbv4-ns mt4-ns">
<ul class="list ma0 ph0">
<li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../intro/ class="db black">Introduction</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../hardware/ class="db black">Hardware</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../firmware/ class="db black">Firmware</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../diy/ class="db black">DIY & Troubleshooting</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../glossary/ class="db black">Glossary</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../installs/ class="db black">Installs</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../networking/ class="db black">Networking</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../nodes/ class="db black">Nodes</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../organization/ class="db black">Organization</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../security/ class="db black">Security</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 8 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M7.5 8l-5 5L1 11.5 4.75 8 1 4.5 2.5 3z"/></svg>
<a href=../../services/ class="db black">Services</a>
</div></li><li>
<div class="flex items-center pv2"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="16" viewBox="0 0 10 16" fill="#ccc" class="red mr2"><path fill-rule="evenodd" d="M5 11 0 6l1.5-1.5L5 8.25 8.5 4.5 10 6z"/></svg>
<a href=../../software/ class="db black">Software</a>
</div><ul class="ma0 pa0 ml3 pl2">
<a href=../../software/nsm5-flash/ class="db mv3 ml0 gray">
Flashing Nanostation M5 with NYC Mesh Firmware
</a>
<a href=../../software/watchdog/ class="db mv3 ml0 gray blue fw5">
Watchdog
</a>
</ul></li></ul></div></div></div><div class="overflow-y-scroll-ns w-80-ns">
<header class="dn ph4 h3 flex-ns flex-row items-center justify-start-l justify-center sans-serif bg-white">
<div class="w-100-ns f4 measure-wide flex items-center justify-end">
<nav class="f5 flex flex-wrap justify-center">
<a href=https://nycmesh.net/ class="f5 blue">Main Site â†’</a>
</nav></div></header><main class="bg-white bt bw05 b--light-gray sans-serif flex flex-row-l flex-column">
<div class="bg-white w-100 pa4-ns pa3">
<div class=f4>
<div class="flex items-center justify-between">
<h1 class=mv0>
Watchdog
</h1><a class="nowrap pl2" target=_ href=https://github.com/nycmeshnet/docs/blob/master/content/software/watchdog.md>
<div class="ba b--light-gray br2 pa2 f6 fw5 black flex"><svg class="mr1 h1 db-ns dn" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
<span>Edit<span class="dn di-ns pre"> on GitHub</span></span>
</div></a>
</div><div class=f5>
<div class=f6>
<p>
Last updated
September 23, 2018 by olivernyc
</p></div><p>Wireless networks have a bit of a reputation for instability. Modern hardware has fixed most hardware problems, but there is work that needs to be done to make the firmware reliable. You can do this with &ldquo;watchdog&rdquo; scripts. I haven&rsquo;t had to reboot a router that is running our watchdog script.</p><p>Our firmware image (based on qMp) comes with a &ldquo;bmx6health&rdquo; script that checks whether the mesh software is running correctly and restarts it if necessary. This script by default runs once per day. I&rsquo;ve found it better to run this every 5 minutes. You can do this by editing the crontab-</p><p>ssh into the router and in the terminal-</p><pre tabindex=0><code>crontab -e
</code></pre><p>This opens a <a href=http://www.lagmonster.org/docs/vi.html>vi editor</a> and you can change or add different scripts to run at different times. (The vi commands you need are &ldquo;i&rdquo; to insert, &ldquo;esc&rdquo; to stop editing, and &ldquo;:x&rdquo; to save and eXit.)</p><p>For some nodes, their main purpose is to be an internet gateway. To ensure that they always try to be online, you can add a watchdog script that pings a known website and calls &ldquo;network restart&rdquo; if it fails. These kind of scripts often ping 8.8.8.8, which is Google&rsquo;s DNS server.</p><p>I&rsquo;ve discovered 3 ways to recover a qMp mesh router that has functioning wifi but has lost internet- <code>network restart</code>, <code>bmx6 restart</code> and restarting dnsmasq-<code>killall dnsmasq; dnsmasq start</code>. Sometimes the dns forwarder, dnsmasq will stop working correctly letting you ping some things and not others. dnsmasq will then forward bad dns info to the other routers too so it needs to be fixed quickly! <code>killall dnsmasq; dnsmasq start</code> will fix it.</p><p>gwck is a qMp utility that is restarted after network restart.</p><p>Another problem I&rsquo;ve had occasionally is that the wifi will lose connections. Even though the radio is on and the router lights are normal you can&rsquo;t connect. I&rsquo;ve written a simple script to restart wifi if both the ad-hoc and access point interfaces have no connections. It is a bit of a hack since the interface may be ok, but since nothing is connected via wifi it doesn&rsquo;t hurt too much to restart it. I&rsquo;ve also found that a network restart is necessary to make the wifi stable.</p><p>By default wlan0 is the ad-hoc interface that is used to mesh the routers and wlan0ap is the access point. This script checks to see the number of wireless interfaces so it works with dual-band routers and routers that are only ad-hoc or ap.</p><p>I&rsquo;m using &ldquo;Signal: unknown&rdquo; to show there is no connection. It seems to work reliably. You could also try iwinfo wlan0 assoclist.</p><p>&ldquo;sleep 5&rdquo; is usual between &ldquo;wifi down&rdquo; and &ldquo;wifi up&rdquo;. I&rsquo;ve found it not necessary when there are no connections, but I&rsquo;ll leave it there in case.</p><p>You can <a href=../../download/watchdog.html>download the watchdog here</a></p><p>in the terminal-</p><pre tabindex=0><code>vi /root/mesh-watchdog.sh
</code></pre><p>and paste this:</p><pre tabindex=0><code>#!/bin/sh
# mesh-watchdog v1.1.1, NYC Mesh, Brian Hall

restartWifi()
{
  wifi down
  sleep 5
  wifi up
}

restartNetwork()
{
  /etc/init.d/network restart
  if /etc/init.d/gwck enabled; then
    /etc/init.d/gwck restart
  fi
  /etc/init.d/bmx6 restart
  sleep 4
  killall dnsmasq
  /etc/init.d/dnsmasq start
}

#gets date-time from log and exit if recently run. date-time is first two words of last line
exitIfRecentRestart()
{
if [ -e $LOG ]; then
  set -- `tail -1 $LOG`
  LASTRUN=`date --date=&#34;$1 $2&#34; +%s`
  if [ &#34;$?&#34; = &#34;0&#34; ]; then
    #don&#39;t run for 1200s (20 minutes)
    NEXTRUN=$(($LASTRUN + 1200))
    NOW=`date +%s`
    es=$(($NOW - $LASTRUN))
    printf &#34;time since last restartNetwork: &#34;
    printf &#39;%dd %dh:%dm:%ds\n&#39; $(($es/86400)) $(($es%86400/3600)) $(($es%3600/60)) $(($es%60))
    if [ $NOW -lt $NEXTRUN ]; then
      echo &#34;waiting $(($NEXTRUN - $NOW)) seconds, use option -f to force&#34;
      exit 1
    else
      echo &#34;run tests-&#34;
    fi
  else
    echo &#34;invalid date from log, run tests-&#34;
  fi
else
 echo &#34;no log, run tests-&#34;
fi
}

LOG=&#34;/tmp/log/mesh-watchdog.log&#34;
FORCE=0

if [ &#34;$1&#34; = &#34;-n&#34; ]; then
  echo &#34;restartNetwork&#34;
  restartNetwork
  exit 1
elif [ &#34;$1&#34; = &#34;-f&#34; ]; then
  echo &#34;force tests-&#34;
  FORCE=1  
elif [ &#34;$1&#34; = &#34;-w&#34; ]; then
  echo &#34;restartWifi&#34;
  restartWifi
  exit 1
elif [ &#34;$1&#34; = &#34;-b&#34; ]; then
  echo &#34;restart wifi, wait, restart network&#34;
  restartWifi; wait 60; restartNetwork
  exit 1
elif [ &#34;$1&#34; != &#34;&#34; ]; then
  echo -e &#34;Usage: `basename $0` [OPTION]\n\nTests wifi and internet connections and restarts if necessary (default)\n\n\t-f\tforce test\n\t-n\trestart network\n\t-w\trestart wifi\n\t-b\trestart both wifi and network\n\t-h\toptions\n&#34;
  exit 1
fi

if [ $FORCE != 1 ]; then
  exitIfRecentRestart
fi

DATE=`date +%Y-%m-%d\ %H:%M:%S`  
IWINFO=`iwinfo`

# find lines containing &#34;ESSID&#34;|get name (previous word)|replace return with &#34;,&#34;
WI=`echo &#34;$IWINFO&#34; | grep ESSID | grep -Eo &#39;^[^ ]+&#39; | sed &#39;:a;N;$!ba;s/\n/, /g`
# count the number of wlan interfaces, and number of wlans with &#39;no signal&#39;
WLAN=`echo &#34;$WI&#34; | wc -w`
NOSIGNAL=`echo &#34;$IWINFO&#34; | grep &#39;Signal: unknown&#39; | wc -l`

if [ $WLAN -eq 0 ]; then
  echo &#34;no wlan interfaces, wifi is probably disabled&#34;
elif [ $WLAN -eq $NOSIGNAL ]; then
  # all wlan interfaces are down, so restart wifi
  echo &#34;$DATE restart wifi- wlans:$WLAN no-signal:$NOSIGNAL interfaces:$WI&#34; | tee -a $LOG
  restartWifi
  sleep 60
  restartNetwork
  exit 1
else
  echo &#34;wifi:ok wlans:$WLAN no-signal:$NOSIGNAL interfaces:$WI&#34;
fi

# restart network if ping google.com &amp;&amp; 8.8.8.8 fails 4 times
count=1
while [ &#34;$count&#34; -le 4 ]
 do
   if /bin/ping -c 1 google.com &gt;/dev/null &amp;&amp; /bin/ping -c 1 8.8.8.8 &gt;/dev/null; then
      echo &#34;wan:ok  ping-count:$count&#34;
      exit 0
   fi
 let count++
done
echo &#34;$DATE network restart&#34; | tee -a $LOG
restartNetwork
</code></pre><p>Make it executable-</p><pre tabindex=0><code>chmod +x /root/mesh-watchdog.sh
</code></pre><p>Afterwards, add the following entry with crontab -e</p><pre tabindex=0><code>* * * * * /root/mesh-watchdog.sh
</code></pre><p>It can run once a minute as it detects whether a network restart has just occurred and will wait 20 minutes before restarting again. I added the 20 minute delay so the router is still functional without an internet gateway.</p><p>Thanks to Nitin for help with the wifi problem and Zach for help with dnsmasq.</p><p><a href=mailto:brian@nycmesh.net>Email me</a> if you have any questions or suggestions.</p></div></div></div></main></div></div></body></html>